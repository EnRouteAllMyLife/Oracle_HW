---
output:
   html_document:
    code_folding: hide
    always_allow_html: true
    toc: true
    toc_float: true
    css: styles.css
---

```{r setup}
knitr::opts_chunk$set(
  collapse = TRUE, 
  warning = FALSE, 
  message = FALSE,
  fig.dim = c(8, 4),
  fig.format = "png")
```

# Main Questions

The report will discuss three main questions:

* Do diagnosed patients experience a higher frequency of hospitalizations over a six-month period? If so, to what extent??
* Comapared to Type 2 Diabetes, are patients with Type 1 Diabetes more likely to adhere to medication regimens, as indicated by lower scores on the Medication Adherence Scale (MMAS)? Furthermore, among Type 1 Diabetes patients, does increased non-adherence, reflected by higher MMAS scores, correlate with a higher frequency of hospitalizations? 
* For Type2 Diabetes patients, how to predict the possibility of hospitalizations in 6 months?


<div style="text-align: center;">
  <img src="graph/Diabetes.webp" style="width: 70%;">
</div>


# EDA

## Descriptive Analysis{.tabset}

We loaded the dataset and assigned variable types according to the code book, identifying 11 factors—6 of which are ordinal—and 11 numeric variables, each with more than five unique values. Below, we detail the descriptive analysis.

The classification within the `DBDX` disease factor, grouping 'Not diagnosed' and 'Not reporting diabetes' together, raises a concern. It suggests the potential oversight of individuals who may have diabetes but remain non-diagnosed, inadvertently categorizing them outside the diagnosed group.For this study, our data primarily concentrate on life quality scores rather than genetic or other predictors that could lead to diabetes. Consequently, we have simplified our approach by not distinguishing between non-diagnosed diabetes patients and those who have not reported the condition. This simplification have made the following implementations much easier. 

```{r load package and data}
library(tidyverse)
library(readr)
library(plotme)
library(glmnet)
library(plotly)
library(kableExtra)
library(mpath)
library(zip)
library(pscl)
library(MatchIt)

theme_set(theme_bw() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d


df_raw = read.delim("./data/nhwsdata.txt") 

df = df_raw |>
  # deal with nominal data
  mutate(across(c(DESEX, DBDX,DBTYPE,DBRX,DBIN), ~factor(.))) |>
  # probably should treat RP MH RE as continuous...
  mutate(across(c(BP, GH,PF, VT, SF,MMAS), ~factor(., ordered = TRUE))) ##|>
 # mutate(across(c(BP, GH, MH, PF, RE, RP,VT, SF,MMAS), ~factor(., ordered = TRUE))) ##|>
 # mutate(across(c(BP, GH, MH, PF, RE, RP,VT, SF,MMAS), ~factor(.))) 

# Detecting continuous and categorical variables
continuous_vars <- c()
categorical_vars <- c()

for(col_name in names(df)) {
  # Assuming continuous variables are of type numeric and have more unique values
  if(is.numeric(df[[col_name]]) && length(unique(df[[col_name]])) > 5) { 
    continuous_vars <- c(continuous_vars, col_name)
  } else { 
    categorical_vars <- c(categorical_vars, col_name)
  }
}
```

### Categorical Variables
```{r, cat}
# delete zKey```

df |> select(all_of(categorical_vars)) |> 
  skimr:: skim()|>
  knitr::kable(digits = 3)|> 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12)|> 
  kableExtra::scroll_box(width = "100%", height = "300px")
```
### Continuous Variables

```{r, con}
# delete zKey```

df |> select(all_of(continuous_vars)) |> 
  skimr:: skim()|>
  knitr::kable(digits = 3)|> 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12)|> 
  kableExtra::scroll_box(width = "100%", height = "300px")
```

## Visualization{.tabset}


We created a series of plots to compare the distribution of variables between different groups.


### Demographic

We observed that demographic variables exhibit different distribution between the hospitalized and non-hospitalized groups. Notice that for missing values in `BMI`, given the missing rate is relatively small and sample size is large enough, we implemented the missing value with the mean.

```{r start over with data pre processing}

# delete zKey
continuous_vars = continuous_vars[-1]

df = df_raw |>
  # deal with nominal data
  mutate(DBTYPE = if_else(is.na(DBTYPE), 0, DBTYPE),
         DBRX = if_else(DBRX == 1, 1, 0, missing = 0),
         DBIN = if_else(DBIN == 1, 1, 0, missing = 0),
         MMAS = if_else(is.na(MMAS),-1,MMAS),
         BMI = if_else(is.na(BMI), mean(df_raw$BMI, na.rm = TRUE), BMI)) |>
  mutate(across(c(DESEX, DBDX,DBTYPE,DBRX,DBIN), ~factor(.))) |>
  mutate(across(c(BP, GH,  PF, VT, SF,MMAS), ~factor(.))) |>
  mutate(IFHOS = if_else(RUHP6Q >0,1,0))
#  mutate(across(c(BP, GH, MH, PF, RE, RP,VT, SF,MMAS), ~factor(.)))  
# don't checked on the order, so all categorical data will be one-hot encoding

# save from the labeling
df_encode = df |>
  mutate(DBMed= if_else(DBRX == 1 & DBIN == 1, "Oral & Insulin",
                        if_else(DBRX == 1 & DBIN == 0, "Oral only",
                               if_else(DBRX == 0 & DBIN == 1, "Insulin only","None"))),
         BMI = if_else(is.na(BMI), mean(df_raw$BMI, na.rm = TRUE), BMI))|>
  mutate(DESEX = factor(DESEX, levels = c(1, 2), labels = c("Male", "Female")),
         DBDX = factor(DBDX, levels = c(0, 1), labels = c("Not Diagnosed", "Diagnosed")),
         DBTYPE = factor(DBTYPE, levels = c(0, 1, 2), labels = c("Not Diagnosed", "Type 1", "Type 2")),
         DBRX = factor(DBRX, levels = c(0, 1), labels = c("Not Using Oral", "Using Oral")),
         DBIN = factor(DBIN, levels = c(0, 1), labels = c("Not Using Insulin", "Using Insulin")),
         IFHOS = factor(IFHOS,levels = c(0,1), labels = c("Non-Hospitalized","Hospitalized"))) 
```

We generate a new binary variable, `IFHOS`, to denote whether the patient has been hospitalized in the past 6 months. This variable is assigned a value of 1 if the value of `RUHP6Q` is greater than 0, indicating a recent hospitalization, and 0 otherwise.

```{r ifhos}
p1 = ggplot(df_encode |> filter(!is.na(BMI)), aes(x = BMI,col = IFHOS)) +geom_density() 
p2 = ggplot(df_encode , aes(x = DEAGE,col = IFHOS)) +geom_density()
p3 = ggplot(df_encode , aes(x = DESEX,fill = IFHOS)) +geom_bar()

subplot(style(ggplotly(p1), showlegend = FALSE),
        style(ggplotly(p2), showlegend = FALSE),
        ggplotly(p3),nrows = 1,titleX=TRUE)
```


### Diabetes

We observed that a series of variables related to diabetes diagnosis, type, and medication show missing values. Given that `DBDX`, annotated as 'Not diagnosed, Missing = Not reporting diabetes,' is categorized into am single group, it is logical to treat missing values in variables directly influenced by `DBDX` (such as `DBTYPE`, `DBRX`, and `DBIN`) as 0.

Approximately 11.1% of the population was diagnosed with diabetes, of which only 6% were classified as Type 1. Regarding medication, all Type 1 patients were found to use both oral medications and insulin. For Type 2 diabetes, three medication combinations were identified: 1) those who used both oral medications and insulin, 2) those who used oral medications only, and 3) those who did not use either oral medications or insulin. The proportions of each category can be visualized in the following chart.

```{r, relationship of disease, type, oral and insulin use}
df_encode |>
  count(DBDX, DBTYPE, DBIN, DBRX#,wt = RUHP6Q
        ) |>
  count_to_sunburst(fill_by_n = TRUE)

```

### MMAS & CCI

`MMAS` is also related to the diagnosis of diabetes, only people who were diagnosed had records; Since it is ordinal data, we opted to fill its missing values with -1 to preserve the original meaning without distortion. 


```{r}
p1 = df_encode |> ggplot(aes( x = CCI,col = DBDX)) + geom_density()

p2 = df_encode |> ggplot(aes( x = DBDX, y = CCI,fill = DBDX)) + geom_boxplot()

subplot(style(ggplotly(p1), showlegend = TRUE),
        style(ggplotly(p2), showlegend = FALSE),titleX=TRUE)
```

### SF-36

[Short Form 36 (SF-36) Health Survey](https://hqlo.biomedcentral.com/articles/10.1186/s12955-017-0625-9) includes 36 items or questions that assess functional health and well-being from the perspective of the patient. The items contribute to eight health domains of physical functioning(`PF`), role limitations due to physical problems(`RP`), bodily pain(`BP`), general health(`GH`), vitality(`VT`), social functioning(`SF`), role limitations due to emotional problems(`RE`) and mental health(`MH`) . The eight domains all contribute to physical component summary (`PCS`) and mental component summary (`MCS`) scores. 

Given the eight subdomains SF-36 are likely to contribute to `PCS` and `MCS` scores. It's essential to check the correlation pairwise in case of multicollinearity.

```{r}
SF_36 = c("PCS","MCS","PF","RE","RP","SF","VT", "GH" ,"MH","BP")

p1 = df_encode |> ggplot(aes( x = PCS,col = IFHOS)) + geom_density()
p2 = df_encode |> ggplot(aes( x = MCS,col = IFHOS)) + geom_density()
subplot(style(ggplotly(p1), showlegend = TRUE),
        style(ggplotly(p2), showlegend = FALSE),titleX=TRUE)
```
### WPACTIMP

```{r, WPACTIMP}
p1 = ggplot(df_encode, aes(WPACTIMP, fill = factor(WPACTIMP),
                           text = paste("WPACTIMP",WPACTIMP ,"<br>Count:", ..count..))) + 
  geom_bar() 

p1 = df_encode |> group_by(WPACTIMP) |> 
  summarise(cnt =n()) |>
  ggplot(aes(x= WPACTIMP, y = cnt, fill = factor(WPACTIMP),
            text = paste("WPACTIMP",WPACTIMP ,
                         "<br>Count:", cnt))) + 
  geom_bar(stat = "identity",position = "dodge")

style(ggplotly(p1,tooltip = "text"), showlegend = FALSE)
```

### RUHP6Q(the outcome)

We compared `RUHP6Q` values between diagnosed and non-diagnosed groups via a bar plot, noticing many zeros, indicating overdispersion and the potential need for specialized models. The diagnosed group showed higher means and standard errors, as expected.


```{r,RUHP6Q}

# for annotation only 
df_summary = df_encode |> group_by(DBDX) |> 
  summarise(mean = round(mean(RUHP6Q), 4),
            sd = round(sd(RUHP6Q),4))
# 
p1 = df_encode |> group_by(RUHP6Q,DBDX) |> 
  summarise(cnt =n()) |>
  mutate(percentage = round(cnt / 75000* 100,2)) |>
  
  ggplot(aes(x= RUHP6Q, y = cnt, fill = DBDX,
            text = paste("RUHP6Q",RUHP6Q ,
                         "<br>Count:", cnt,
                         "<br>Perc:", paste0(percentage,"%")))) + 
  geom_bar(stat = "identity",position = "dodge")+
  geom_text(x = 70, y = 62000, 
            label = paste("DBDX = 0", "; Mean",df_summary[1,2],"; SD",df_summary[1,3]),
            size = 3
            )+
  geom_text(x = 70, y = 59000, 
            label = paste("DBDX = 1", "; Mean",df_summary[2,2],"; SD",df_summary[2,3]),
            size = 3
            )
p1_plotly = ggplotly(p1,tooltip = "text")
p1_plotly
```


### Correlation 

Two pairs of variables, `MH` & `MCS`, `RP` & `RPS`, exhibit a high correlation (greater than 0.8), suggesting that one variable from each correlated pair should be considered for exclusion to avoid multicollinearity.

```{r, corrplot}
corrplot::corrplot(cor(df |> select(any_of(continuous_vars))), "number")
#df = df |>select(-RP)
```

# Q1. 

**Do diagnosed patients experience a higher frequency of hospitalizations over a six-month period? If so, to what extent?**

Based on the information provided in the plot:

- The 'Diagnosed' group (`DBDX` = 1) has a mean value of `r df_summary[2,2]` with a standard deviation (SD) of `r df_summary[2,3]`.
- The 'Not Diagnosed' group (`DBDX` = 0) has a mean value of `r df_summary[1,2]` with an SD of `r df_summary[1,3]`.

The higher mean in the 'Diagnosed' group suggests that, on average, diagnosed patients have a higher frequency of hospitalizations over six months compared to non-diagnosed patients.Also, the Wilcoxon rank sum test shows there is a statistically significant difference in the `RUHP6Q` variable between the two groups, with the median value of `RUHP6Q` being significantly higher in the diagnosed group than in the non-diagnosed group($\alpha = 0.05,\ W =36532880,\ p-value < 2.2e-16$) . Moreover, the larger standard deviation in the 'Diagnosed' group indicates more variability in hospitalization frequency among diagnosed patients.

```{r, q1 wilcox}
x = df |> filter(DBDX == 1) |> select(RUHP6Q) |> pull()
y = df |> filter(DBDX == 0) |> select(RUHP6Q) |> pull() 
wilcox.test(x,y, alternative = "greater")
```

To accurately quantify the difference, we plan to construct a regression model. However, prior to this, it's crucial to address an important concern related to demographic characteristics.

Age and BMI are significant risk factors for diabetes. Older age groups often have a higher prevalence of diabetes, and higher BMI is associated with an increased risk of developing type 2 diabetes. Such trend could be observed from the plot below.By including these variables, the model accounts for important risk factors that might influence the probability of being diagnosed with diabetes. Age, BMI, and sex are also potential confounders because they can be associated with both the likelihood of receiving a diagnosis (exposure) and the outcome of interest. If not adjusted for, these variables could bias the results of the study. Therefore, prior to developing the regression model, we constructed a propensity score model utilizing `DEAGE`, `BMI`, and `DESEX` as predictors of `DBDX`. The propensity score model serves to balance these groups and thereby enhance the robustness of the subsequent regression analysis.

```{r, demographic by diagnos}
p1 = ggplot(df_encode |> filter(!is.na(BMI)), aes(x = BMI,col = DBDX)) +geom_density()
p2 = ggplot(df_encode , aes(x = DEAGE,col = DBDX)) +geom_density()
p3 = ggplot(df_encode , aes(x = DESEX,fill = DBDX)) +geom_bar()

subplot(style(ggplotly(p1), showlegend = FALSE),
        style(ggplotly(p2), showlegend = FALSE),
        ggplotly(p3),nrows = 1,titleX=TRUE)

```


This helped account for baseline differences that could affect both the likelihood of disease and the outcomes `RUHP6Q`.PSM helped ensure that the comparison between diagnosed and non-diagnosed groups in subsequent NB and ZINB regressions is fair and balanced.Almost 99.9% in the diagnosed group was matched 1-1 to the non-diagnosed group. We then applied negative binomial regression and zero-inflated models, with a detailed summary available in the hidden code section. 


```{r Q1}

# build a PSM based on age, sex, bmi
#ps_model <- matchit(DBDX ~ DEAGE + BMI +DESEX, data = df, method = "nearest",caliper = 0.2)
#saveRDS(ps_model, file = "./model/ps_model_cci.rds")
ps_model <- readRDS("./model/ps_model.rds")
# Check balance before and after matching
summary(ps_model)

# Extract the matched data
matched_data <- match.data(ps_model)

nb_m1 <- MASS::glm.nb(RUHP6Q ~ DBDX, data = matched_data)
summary(nb_m1)

zinp_m1 <-zeroinfl(RUHP6Q~ DBDX,data= matched_data , dist="negbin") 
summary(zinp_m1)
```


The Negative Binomial regression analysis reveals a significant difference in `RUHP6Q` between groups defined by `DBDX`. Specifically, the `DBDX1` coefficient is positive and significant, indicating that being in the diagnosed group is associated with a higher count of `RUHP6Q`, compared to the non-diagnosed group. The model's fit is underscored by a substantial difference between the null and residual deviance, and a relatively low theta suggests overdispersion. The coefficient for `DBDX1` suggests that diagnosed individuals have a \( e^{0.6779} \approx 1.97 \) times higher rate of hospitalizations in the past 6 months compared to those not diagnosed, all else being equal. This indicates a significant impact of diagnosis on hospitalization frequency.


As for the Zero-Inflated Negative Binomial model fitted to `RUHP6Q` against `DBDX`. In the count model, `DBDX1` has a positive coefficient, indicating an association between being in the `DBDX1` group and an increase in the `RUHP6Q` count. The significant negative coefficient for `Log(theta)` suggests overdispersion in the data. The zero-inflation part's intercept is significant, suggesting different levels of zero counts not explained by the count model alone, but the `DBDX1` effect is not significant here, indicating no clear difference in zero-inflation between `DBDX` groups.

Given the zero-inflation part for `DBDX1` is not significant and zero-inflated models offer relative a nuanced understanding. We stick with the result from Negative Binomial regression model. As it suggested, diagnosed individuals have around 1.97 times higher rate of hospitalizations in the past 6 months compared to those not diagnosed.This association underscores the healthcare needs and challenges faced by those diagnosed with conditions requiring ongoing treatment or observation.

Reasons why diagnosed patients might have a larger frequency of hospitalizations could include:

1. **Management of the diagnosed condition:** Patients with a diagnosis may require regular hospital visits for treatment or management of their condition.
2. **Complications:** A diagnosed condition may lead to complications that necessitate frequent hospital stays.
3. **Monitoring:** Some conditions might require close medical monitoring, possibly in a hospital setting.
4. **Post-diagnosis care:** Initial hospitalizations might be more frequent as the care protocol is established immediately following diagnosis.


# Q2.

**Comapared to Type 2 Diabetes, are patients with Type 1 Diabetes more likely to adhere to medication regimens, as indicated by lower scores on the Medication Adherence Scale (MMAS)?**

Patients with Type 1 Diabetes tend to have better medication adherence scores compared to those with Type 2, largely due to the essential nature of insulin therapy for survival and the early onset of the disease, which comes with comprehensive education on disease management. Additionally, the routine of continuous glucose monitoring and insulin administration fosters a disciplined approach to treatment adherence. These factors, combined with the immediate feedback provided by blood glucose levels, help reinforce the critical importance of sticking to the prescribed medication regimen. So naturally, we wanted to know if patients with Type 1 Diabetes are more likely to adhere to medication regimens compared to Type 2 patients, as indicated by lower scores on the Medication Adherence Scale (MMAS)

We exclusively considered patients with confirmed diagnoses and employed a chi-square test to investigate potential disparities in the distribution of Morisky Medication Adherence Scores (`MMAS`) between individuals with Type1 and Type2 diabetes. The analysis revealed statistically significant differences in `MMAS` distribution between Type1 and Type2 diabetes patients (see the results provided). With a significance level set at 0.05, the findings indicate no significant discrepancies in `MMAS` distribution among the two diabetic subgroups (p value 0.5107).But, if we calculated the mean among the two group, excluding the missing values, we noticed that Type1 patients have larger MMAS(Type1 2.53, Type2 2.33), that is greater non-adherence.

```{r Q2 chisq}
df_db = df |> filter(DBTYPE!="0" & MMAS != '-1') 
chisq.test(df_db[["DBTYPE"]], df_db[['MMAS']])
```

The pie charts further illustrate the there might be little difference between the group.

```{r Q2 plot}
df|> mutate(MMAS = as.numeric(MMAS))|> 
  filter(MMAS > -1 ) |>
  group_by(DBTYPE) |> summarise(mean(MMAS))

df_db_group = df_db|> group_by(DBTYPE,MMAS) |> summarise( cnt =  n())
plot_ly()|>
  add_pie(
    data = df_db_group |> filter(DBTYPE == "1"), labels = ~MMAS, values = ~cnt,
    colors = viridis::viridis_pal()(5),
    textposition = "inside", textinfo = "label+percent",
    name = "Type 1", domain = list(row = 0, column = 0)
  )|>
  plotly::add_pie(
    data = df_db_group|> filter(DBTYPE == "2"), labels = ~MMAS, values = ~cnt,
    colors = viridis::viridis_pal()(5),
    textposition = "inside", textinfo = "label+percent",
    name = "Type 2", domain = list(row = 0, column = 1)
  )|>
  layout(
   # title = "多图布局", showlegend = F,
    grid = list(rows = 1, columns = 2),
    xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
    yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
    colorway = viridis::viridis_pal()(5)
  )|> 
  config(displayModeBar = FALSE) 
```

**For Type 1 Diabetes patients, does higher MMAS lead to higher frequency of hospitalizations?**


Specifically focusing on Type 1 diabetes patients, we constructed a negative binomial regression model. Given that the Morisky Medication Adherence Score (`MMAS`) variable only takes 5 unique values, we treated it as categorical data, resulting in a slightly complex interpretation. Comparing patients with `MMAS` = 0 to those with `MMAS` = 1,2 we found that the former group had approximately \( e^{0.4924} \approx 1.64 \) times higher rates of hospitalizations in the past 6 months, while the latter group had approximately \( e^{0.1285} \approx 1.14 \) times higher rates. However, for higher levels of `MMAS` (`MMAS`= 3,4), they exhibited the opposite effect, suggesting potentially confounding factors such as limited sample size.


The statement "higher levels of `MMAS` lead to lower rates of hospitalization" might seem counterintuitive, especially given the expectation that better medication adherence (lower `MMAS` scores) should lead to better health outcomes and, consequently, lower rates of hospitalization. However, several factors could explain this apparent contradiction:

*Confounding Variables*: There might be confounding variables that are not accounted for in the analysis. These variables could influence both `MMAS` and hospitalization rates simultaneously, leading to a spurious association between `MMAS` and hospitalization.

*Reverse Causality*: It's possible that the relationship between `MMAS` and hospitalization is bidirectional. In other words, not only does medication adherence affect hospitalization rates, but hospitalization experiences could also influence future medication adherence. For example, individuals who have experienced frequent hospitalizations may become more vigilant about medication adherence, resulting in lower `MMAS` scores.


```{r, Q2 nb}
nb_m2 <- MASS::glm.nb(RUHP6Q ~ factor(MMAS), data = df |> filter(DBTYPE == 1 ))
summary(nb_m2)
```


# Q3.

**For Type2 DB patients, how to predict the possibility of hospitalizations in 6 months?**

According to [the National Institute of Diabetes and Digestive and Kidney Disease](https://www.niddk.nih.gov/health-information/diabetes/overview/symptoms-causes), the causes of Type 1 and Type 2 diabetes are quite distinct. Type 1 diabetes is believed to occur when the immune system attacks and destroys insulin-producing beta cells in the pancreas, with genetics and environmental factors like viruses potentially triggering this autoimmune response. Type 2 diabetes is primarily caused by lifestyle factors and genetics, including being overweight, physically inactive, and having insulin resistance. Obesity and physical inactivity increase the risk, and the disease often runs in families, being more common in certain racial/ethnic groups. Also, Type 1 is an autoimmune condition with onset typically in younger individuals, requiring insulin management from the start. Type 2, more prevalent and influenced by lifestyle and genetics, usually appears in adults but is increasingly found in younger populations due to lifestyle factors. Management may start with lifestyle changes and medication, with insulin needed as the condition progresses. 

Given the distinct nature of Type 1 and Type 2 diabetes, it is prudent to develop predictive models separately for each type. Due to the limited sample size available for Type 1 diabetes, our focus was directed solely towards Type 2.

```{r groupby DBTYPE}

df |> group_by(DBTYPE) |>summarise( hospitalizations = sum(IFHOS),
                                    non_hospitalizations = n()-sum(IFHOS))

df |> group_by(DBTYPE) |>summarise( yes = sum(IFHOS),
                                    no = n()-sum(IFHOS))
```


The LASSO regression model, used for variable selection and shrinkage, indicates key factors influencing the number of hospitalizations in the past 6 months (`RUHP6Q`). We used cross validation to find the best performed hyperpramater(highest AUC). 

The bar plot displays the estimate of coefficients from the lasso regression, wherein we filtered only those with an absolute value larger than 0. Among these variables,  the variable `CCI` (Charlson comorbidity index) demonstrates a positive association with the outcome. This finding aligns with expectations, as a greater burden of comorbidities, as captured by the Charlson index, is likely to increase the complexity of patient care and thereby contribute to a higher frequency of hospitalizations. Additionally, `DBIN1` (indicating the use of insulin) exhibits a significant positive association, suggesting that individuals requiring insulin are more likely to experience frequent hospitalizations. This association may stem from the fact that insulin therapy is often prescribed to individuals with more severe forms of diabetes, necessitating closer medical monitoring and potentially leading to a higher likelihood of hospital admissions.

`WPACTIMP`(Activity impairment) also has a positive association with the outcome. Given activity impairment may indicate more severe or poorly managed diabetes, leading to complications requiring hospitalization. Also, patients with higher activity impairment may have comorbid conditions that both exacerbate diabetes and increase the likelihood of hospitalization.The association seems very reasonable.

The negative impact observed for `PCS`, `SF`, `VT`on the likelihood of hospitalization aligns with the expectation that better physical, vitality and social functioning are associated with improved overall health outcomes, reduced susceptibility to illness or injury, and enhanced support mechanisms that help individuals manage their health needs outside of hospital settings.

Variables like `BMI` and `DESEX2` (Female) also contribute to the model, albeit with smaller and in some cases negative coefficients, affecting the hospitalization rate differently. Notably, `BMI` has a negative coefficient, suggesting that higher BMI is associated with fewer hospitalizations, which may require further investigation to understand the underlying context.

It's important to consider the possibility of confounding variables or complex interactions within the dataset that may influence the relationship among predictors and hospital admissions. Further investigation, including additional analyses or exploration of underlying mechanisms, may be necessary to fully understand this association.

```{r lasso}
set.seed(2378)
source("./function/lasso_regression.R")
df = df |> mutate(MMAS = factor(MMAS))
result_lasso_typ2 = db_lasso(df, "Type2" ,prop = 0.7)
#result_lasso_nd = db_lasso(df, DBtype =0 )
result_lasso_typ2$plot_estimate
performance_matrix = result_lasso_typ2$performance_matrix 
```



The model's performance is characterized by excellent specificity (`r performance_matrix[which(performance_matrix$Term == "Specificity"),][2]`) 
indicating almost all negative cases are correctly identified. However, the sensitivity is exceptionally low at `r performance_matrix[which(performance_matrix$Term == "Sensitivity"),][2]`, meaning the model identifies very few positive cases. The accuracy is high ( `r performance_matrix[which(performance_matrix$Term == "Accuracy"),][2]`), which seems impressive, but it is misleading due to the class imbalance reflected in the prevalence rate ( `r performance_matrix[which(performance_matrix$Term == "Prevalence"),][2]`). The Kappa score is low (`r performance_matrix[which(performance_matrix$Term == "Kappa"),][2]`), suggesting that the agreement between the predicted and actual values is only slightly better than chance. The AUC of `r performance_matrix[which(performance_matrix$Term == "AUC"),][2]` indicates a fair ability to distinguish between the classes. These metrics together suggest that while the model is excellent at predicting the negative class, it fails to adequately capture the positive class, likely due to class imbalance.

```{r model performance}
p = performance_matrix|>
  filter(!(Term %in% c('AccuracyLower','AccuracyUpper','AccuracyNull','AccuracyPValue','McnemarPValue'))) |>
  arrange(desc(Value))|>
    ggplot(aes(x = reorder(Term, Value), y = Value, fill = reorder(Term, Value),
              text = paste("Term:", Term, "<br>Value:", round(Value, 4))
    )) + 
    geom_col() + coord_flip() +
    theme(legend.position = "none") +  
    labs(#title = "Feature Estimate of LASSO Regression",
      x = 'Values',
      y = 'Evaluation Terms')
ggplotly(p, tooltip = "text")
#result_lasso_nd$performance_matrix|>
#  knitr::kable(digits = 3)|> 
 # kableExtra::kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12)|> 
 # kableExtra::scroll_box(width = "100%", height = "300px")
```

# Conclusions

**Does diagnosed patients have larger frequency of hospitalizations?**

Yes. As the Negative Binomial regression model suggested, diagnosed individuals have around 1.97 times higher rate of hospitalizations in the past 6 months compared to those not diagnosed.

**Does Type 1 Diabetes patients have better medication adherence score? For Type 1 Diabetes patients, does higher MMAS lead to higher frequency of hospitalizations?**

Type 1 diabetes patients exhibit a higher mean `MMAS` score relative to those with Type 2; however, this discrepancy is not statistically significant. The `MMAS` score is indicative of medication adherence, with higher scores pointing to greater non-adherence, a factor that could potentially lead to more frequent hospitalizations. Interestingly, an inverse trend is observed at `MMAS` levels 3 and 4, suggesting better adherence may not correspond to fewer hospitalizations. To elucidate this apparent contradiction, further data collection and analysis are required.

**For Type2 DB patients, how to predict the possibility of hospitalizations in 6 months?**

In predicting hospitalization among Type 2 diabetes patients, our LASSO model selected `CCI`, `DBIN`, `WPACTIMP`, `BMI`, `VT`, `PCS`, `DESEX`, and `SF` as significant factors. Most of these associations corroborate our expectations and established understanding. The model's performance could be enhanced by incorporating a larger sample of positive instances.